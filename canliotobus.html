<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>İETT Hat Otobüs Konumları</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 600px; width: 100%; margin-top: 10px; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { padding: 8px; margin-right: 5px; }
  </style>
</head>
<body>
  <h2>İETT Hat Otobüs Konumları</h2>
  <input type="text" id="hatKodu" placeholder="Hat Kodu (örn. 14BK)">
  <button onclick="sorgula()">Sorgula</button>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([41.015, 28.979], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap katkıda bulunanlar'
    }).addTo(map);

    let markers = [];

    function temizleHarita() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    async function sorgula() {
      const hatKodu = document.getElementById('hatKodu').value.trim();
      if (!hatKodu) {
        alert("Lütfen bir hat kodu girin.");
        return;
      }

      temizleHarita();

      const soapBody = `
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
          <soapenv:Header/>
          <soapenv:Body>
            <tem:GetHatOtoKonum_json>
              <tem:HatKodu>${hatKodu}</tem:HatKodu>
            </tem:GetHatOtoKonum_json>
          </soapenv:Body>
        </soapenv:Envelope>`;

      try {
        const response = await fetch("https://cors-anywhere.herokuapp.com/https://api.ibb.gov.tr/iett/ibb/ibb360.asmx", {
          method: "POST",
          headers: {
            "Content-Type": "text/xml;charset=UTF-8",
            "SOAPAction": "http://tempuri.org/GetHatOtoKonum_json"
          },
          body: soapBody
        });

        const text = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        const jsonText = xmlDoc.getElementsByTagName("GetHatOtoKonum_jsonResult")[0].textContent;
        const data = JSON.parse(jsonText);

        if (!Array.isArray(data)) {
          alert("Geçerli bir veri bulunamadı.");
          return;
        }

        data.forEach(bus => {
          const lat = parseFloat(bus.enlem);
          const lng = parseFloat(bus.boylam);
          const marker = L.marker([lat, lng]).addTo(map);
          marker.bindPopup(`
            <b>Kapı No:</b> ${bus.kapino}<br>
            <b>Yön:</b> ${bus.yon}<br>
            <b>Hat Adı:</b> ${bus.hatad}<br>
            <b>Son Konum Zamanı:</b><br>${bus.son_konum_zamani}
          `);
          markers.push(marker);
        });

        if (data.length > 0) {
          const first = data[0];
          map.setView([parseFloat(first.enlem), parseFloat(first.boylam)], 13);
        }

      } catch (error) {
        console.error("Hata:", error);
        alert("Veri alınırken bir hata oluştu.");
      }
    }
  </script>
</body>
</html>
