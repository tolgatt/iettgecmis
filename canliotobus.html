<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>İETT Otobüs Konumları</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #map {
      height: 600px;
      margin-top: 15px;
    }

    input,
    button {
      padding: 8px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h2>İETT Hat Otobüs Konumları</h2>
  <input type="text" id="hatKodu" placeholder="Hat Kodu (örn: 14BK)" />
  <button onclick="sorgula()">Sorgula</button>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([41.015, 28.979], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
    }).addTo(map);

    let markers = [];

    function temizleHarita() {
      markers.forEach((marker) => map.removeLayer(marker));
      markers = [];
    }

    async function getDurakAdi(durakKodu) {
      const soapBody = `
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
           <soapenv:Header/>
           <soapenv:Body>
              <tem:GetDurak_XML>
                 <tem:DurakKodu>${durakKodu}</tem:DurakKodu>
              </tem:GetDurak_XML>
           </soapenv:Body>
        </soapenv:Envelope>`;

      try {
        const response = await fetch(
          "https://e7f44acc-4cc7-4eb8-9a6d-64b8221f8e9a-00-10jlz0zfni4bf.pike.replit.dev/proxy",
          {
            method: "POST",
            headers: {
              "Content-Type": "text/xml; charset=utf-8",
              SOAPAction: "http://tempuri.org/GetDurak_XML",
            },
            body: soapBody,
          }
        );

        const text = await response.text();

        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        const durakAdiNode = xmlDoc.getElementsByTagName("SDURAKADI")[0];
        return durakAdiNode ? durakAdiNode.textContent : durakKodu; // Bulamazsa kodu döndür
      } catch (err) {
        console.error("Durak adı alınırken hata:", err);
        return durakKodu; // Hata olursa kodu döndür
      }
    }

    async function sorgula() {
      const hat = document.getElementById("hatKodu").value.trim();
      if (!hat) {
        alert("Lütfen bir hat kodu girin.");
        return;
      }

      temizleHarita();

      const soapData = `
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
          <soapenv:Header/>
          <soapenv:Body>
            <tem:GetHatOtoKonum_json>
              <tem:HatKodu>${hat}</tem:HatKodu>
            </tem:GetHatOtoKonum_json>
          </soapenv:Body>
        </soapenv:Envelope>
      `;

      try {
        const res = await fetch(
          "https://703df10b-a9f8-4235-a338-e8c5d1282220-00-2pxsdwdz7lkkz.spock.replit.dev/proxy",
          {
            method: "POST",
            headers: {
              "Content-Type": "text/xml;charset=UTF-8",
              SOAPAction: "http://tempuri.org/GetHatOtoKonum_json",
            },
            body: soapData,
          }
        );

        const text = await res.text();

        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");

        const jsonString = xmlDoc
          .getElementsByTagName("GetHatOtoKonum_jsonResult")[0]
          .textContent;

        const otobusler = JSON.parse(jsonString);

        if (!Array.isArray(otobusler) || otobusler.length === 0) {
          alert("Otobüs konumu bulunamadı.");
          return;
        }

        // Tüm durak kodları için durak adlarını çek
        for (const bus of otobusler) {
          if (bus.yakinDurakKodu) {
            bus.yakinDurakAdi = await getDurakAdi(bus.yakinDurakKodu);
          } else {
            bus.yakinDurakAdi = "Bilinmiyor";
          }
        }

        otobusler.forEach((bus) => {
          const marker = L.marker([bus.enlem, bus.boylam]).addTo(map);
          marker.bindPopup(`
            <b>${bus.kapino}</b><br>
            Hat: ${bus.hatad}<br>
            Yön: ${bus.yon}<br>
            Güzergah Kodu: ${bus.guzergahkodu}<br>
            Son Görülme: ${bus.son_konum_zamani}<br>
            Yakın Durak: ${bus.yakinDurakAdi}
          `);
          markers.push(marker);
        });

        map.setView([otobusler[0].enlem, otobusler[0].boylam], 13);
      } catch (err) {
        console.error("Hata:", err);
        alert("Veri alınamadı.");
      }
    }
  </script>
</body>
</html>
